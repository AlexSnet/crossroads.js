/*!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.2
 * @build 16 (04/29/2011 03:05 AM)
 */
(function(a){var e,h,k,c=Object.prototype.toString;function i(l,m){var o=l.length;while(o--){if(l[o]===m){return o}}return -1}function d(l,m){return"[object "+l+"]"===c.call(m)}function f(l){return d("RegExp",l)}function g(l){return d("Array",l)}function b(l){return d("Function",l)}e=(function(){var o=[],s=new signals.Signal();function l(y,z,x){var w=new h(y,z,x);v(w);return w}function v(w){var x=m();do{--x}while(o[x]&&w._priority<=o[x]._priority);o.splice(x+1,0,w)}function m(){return o.length}function p(w){var x=r(w);if(x>=0){o.splice(x,1)}w._destroy()}function r(w){return i(o,w)}function u(){var w=m();while(w--){o[w]._destroy()}o.length=0}function n(x){x=x||"";var w=q(x),y=w?t(x,w):null;if(w){y?w.matched.dispatch.apply(w.matched,y):w.matched.dispatch()}else{s.dispatch(x)}}function q(y){var x=m(),w;while(w=o[--x]){if(w.match(y)){return w}}return null}function t(x,w){return k.getParamValues(x,w._matchRegexp)}return{_routes:o,addRoute:l,removeRoute:p,removeAllRoutes:u,parse:n,bypassed:s,getNumRoutes:m,toString:function(){return"[crossroads numRoutes:"+m()+"]"}}}());h=e.Route=function(n,o,m){var l=f(n);this._pattern=n;this._paramsId=l?[]:k.getParamIds(n);this._matchRegexp=l?n:k.compilePattern(n);this.matched=new signals.Signal();if(o){this.matched.add(o)}this._priority=m||0};h.prototype={rules:void (0),match:function(l){return this._matchRegexp.test(l)&&(f(this._pattern)||this.validateParams(l))},validateParams:function(m){var n=this.rules,l=n?this._getValuesObject(m):null,o;for(o in n){if(n.hasOwnProperty(o)){if(!j(n[o],l[o],l,m)){return false}}}return true},_getValuesObject:function(p){var m=this._paramsId,l=k.getParamValues(p,this._matchRegexp),q={},r=m.length;while(r--){q[m[r]]=l[r]}return q},dispose:function(){e.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._paramsId=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};function j(n,o,l,m){if(f(n)){return n.test(o)}else{if(g(n)){return i(n,o)!==-1}else{if(b(n)){return n(o,m,l)}else{return false}}}}k=e.patternLexer=(function(){var t=/[\\\.\+\*\?\^\$\[\]\(\)\{\}\/\'\#]/g,n=/([^\/]+)/,s=/\{([^\}]+)\}/g,r="___CR_PARAM___",q=new RegExp(r,"g");function o(z){var y=[],x;while(x=s.exec(z)){y.push(x[1])}return y}function v(x){x=x?p(x):"";x=l(x);x=m(x);return new RegExp("^"+x+"$")}function p(x){return x.replace(s,r)}function m(x){return x.replace(q,n.source)}function l(x){return x.replace(t,"\\$&")}function u(x,z){var y=z.exec(x);if(y){y.shift();y=w(y)}return y}function w(y){var A=y.length,x=[],z;while(z=y[--A]){x[A]=(z===null||z===""||isNaN(z))?z:parseFloat(z)}return x}return{getParamIds:o,getParamValues:u,compilePattern:v}}());a.crossroads=e}(window||this));