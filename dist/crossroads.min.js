/*!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.4rc1
 * @build 28 (06/06/2011 10:17 PM)
 */
(function(a){var e,h,j,c=Object.prototype.toString;function i(k,l){var m=k.length;while(m--){if(k[m]===l){return m}}return -1}function d(k,l){return"[object "+k+"]"===c.call(l)}function f(k){return d("RegExp",k)}function g(k){return d("Array",k)}function b(k){return d("Function",k)}e=(function(){var n=[],r=new signals.Signal(),u=new signals.Signal();function k(y,z,x){var w=new h(y,z,x);v(w);return w}function v(w){var x=l();do{--x}while(n[x]&&w._priority<=n[x]._priority);n.splice(x+1,0,w)}function l(){return n.length}function o(w){var x=q(w);if(x>=0){n.splice(x,1)}w._destroy()}function q(w){return i(n,w)}function t(){var w=l();while(w--){n[w]._destroy()}n.length=0}function m(x){x=x||"";var w=p(x),y=w?s(x,w):null;if(w){y?w.matched.dispatch.apply(w.matched,y):w.matched.dispatch();u.dispatch(x,w,y)}else{r.dispatch(x)}}function p(y){var x=l(),w;while(w=n[--x]){if(w.match(y)){return w}}return null}function s(x,w){return j.getParamValues(x,w._matchRegexp)}return{_routes:n,addRoute:k,removeRoute:o,removeAllRoutes:t,parse:m,bypassed:r,routed:u,getNumRoutes:l,toString:function(){return"[crossroads numRoutes:"+l()+"]"}}}());h=function(l,n,k){var m=f(l);this._pattern=l;this._paramsIds=m?null:j.getParamIds(this._pattern);this._matchRegexp=m?l:j.compilePattern(l);this.matched=new signals.Signal();if(n){this.matched.add(n)}this._priority=k||0};h.prototype={rules:void (0),match:function(k){return this._matchRegexp.test(k)&&(f(this._pattern)||this._validateParams(k))&&this._posValidation(k)},_validateParams:function(k){var l=this.rules,m;for(m in l){if(l.hasOwnProperty(m)){if(!this._isValidParam(k,m)){return false}}}return true},_isValidParam:function(m,p){var l=this.rules[p],k=this._getParamValuesObject(m),o=k[p],n;if(f(l)){n=l.test(o)}else{if(g(l)){n=i(l,o)!==-1}else{if(b(l)){n=l(o,m,k)}}}return n||false},_getParamValuesObject:function(m){var l=this._paramsIds,k=j.getParamValues(m,this._matchRegexp),p={},q=l.length;while(q--){p[l[q]]=k[q]}return p},_posValidation:function(l){var k=this.rules?this.rules.request_:null;return k?k(l):true},dispose:function(){e.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};j=e.patternLexer=(function(){var s=/[\\\.\+\*\?\^\$\[\]\(\)\{\}\/\'\#]/g,m=/([^\/]+)/,r=/\{([^\}]+)\}/g,q="___CR_PARAM___",p=new RegExp(q,"g"),v=/^(true|false)$/i;function n(z){var y=[],x;while(x=r.exec(z)){y.push(x[1])}return y}function u(x){x=x?o(x):"";x=x.replace(/\/$/,"");x=k(x);x=l(x);return new RegExp("^"+x+"/?$")}function o(x){return x.replace(r,q)}function l(x){return x.replace(p,m.source)}function k(x){return x.replace(s,"\\$&")}function t(x,z){var y=z.exec(x);if(y){y.shift();y=w(y)}return y}function w(y){var A=y.length,x=[],z;while(z=y[--A]){x[A]=(z===null)?z:(v.test(z)?(z.toLowerCase()==="true"):((z===""||isNaN(z))?z:parseFloat(z)))}return x}return{getParamIds:n,getParamValues:t,compilePattern:u}}());a.crossroads=e}(window||this));