/*!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.4.0+
 * @build 39 (06/28/2011 05:16 PM)
 */
(function(a){var e,m,c=Object.prototype.toString,k=/^(true|false)$/i;function j(o,p){var q=o.length;while(q--){if(o[q]===p){return q}}return -1}function d(n,o){return"[object "+n+"]"===c.call(o)}function f(n){return d("RegExp",n)}function h(n){return d("Array",n)}function b(n){return d("Function",n)}function g(n){return(n===null)?n:(k.test(n)?(n.toLowerCase()==="true"):((n===""||isNaN(n))?n:parseFloat(n)))}function l(p){var q=p.length,o=[];while(q--){o[q]=g(p[q])}return o}e=(function(){function n(){this._routes=[];this.bypassed=new signals.Signal();this.routed=new signals.Signal()}n.prototype={create:function(){return new n()},shouldTypecast:true,addRoute:function(q,r,p){var o=new i(q,r,p,this);this._sortedInsert(o);return o},removeRoute:function(o){var p=j(this._routes,o);if(p>=0){this._routes.splice(p,1)}o._destroy()},removeAllRoutes:function(){var o=this.getNumRoutes();while(o--){this._routes[o]._destroy()}this._routes.length=0},parse:function(p){p=p||"";var o=this._getMatchedRoute(p),q=o?m.getParamValues(p,o._matchRegexp,this.shouldTypecast):null;if(o){q?o.matched.dispatch.apply(o.matched,q):o.matched.dispatch();this.routed.dispatch(p,o,q)}else{this.bypassed.dispatch(p)}},getNumRoutes:function(){return this._routes.length},_sortedInsert:function(p){var o=this._routes,q=o.length;do{--q}while(o[q]&&p._priority<=o[q]._priority);o.splice(q+1,0,p)},_getMatchedRoute:function(q){var o=this._routes,r=o.length,p;while(p=o[--r]){if(p.match(q)){return p}}return null},toString:function(){return"[crossroads numRoutes:"+this.getNumRoutes()+"]"}};return new n()}());function i(p,r,o,n){var q=f(p);this._router=n;this._pattern=p;this._paramsIds=q?null:m.getParamIds(this._pattern);this._matchRegexp=q?p:m.compilePattern(p);this.matched=new signals.Signal();if(r){this.matched.add(r)}this._priority=o||0}i.prototype={rules:void (0),match:function(n){return this._matchRegexp.test(n)&&this._validateParams(n)},_validateParams:function(n){var o=this.rules,p;for(p in o){if(o.hasOwnProperty(p)&&!this._isValidParam(n,p)){return false}}return true},_isValidParam:function(p,s){var o=this.rules[s],n=this._getParamValuesObject(p),r=n[s],q;if(f(o)){q=o.test(r)}else{if(h(o)){q=j(o,r||"")!==-1}else{if(b(o)){q=o(r,p,n)}}}return q||false},_getParamValuesObject:function(r){var t=this._router.shouldTypecast,q=this._paramsIds,p=m.getParamValues(r,this._matchRegexp,t),s={},u=q?q.length:0;while(u--){s[q[u]]=p[u]}s.request_=t?g(r):r;return s},dispose:function(){this._router.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};m=e.patternLexer=(function(){var w=/[\\.+*?\^$\[\](){}\/'#]/g,y=/\/$/g,C=/([:}])\/?(:)/g,n=/\{([^}]+)\}/g,s=/:([^:]+):/g,u=/(?:\{|:)([^}:]+)(?:\}|:)/g,t="___CR_REQ___",A="___CR_OPT___",q="___CR_OPT_SLASH___",D=new RegExp(t,"g"),o=new RegExp(A,"g"),B=new RegExp(q,"g");function p(G){var F=[],E;while(E=u.exec(G)){F.push(E[1])}return F}function z(E){E=E||"";if(E){E=E.replace(y,"");E=v(E);E=E.replace(w,"\\$&");E=r(E)}return new RegExp("^"+E+"/?$")}function v(E){E=E.replace(C,"$1"+q+"$2");E=E.replace(s,A);return E.replace(n,t)}function r(E){E=E.replace(B,"\\/?");E=E.replace(o,"([^\\/]+)?/?");return E.replace(D,"([^\\/]+)")}function x(E,G,H){var F=G.exec(E);if(F){F.shift();if(H){F=l(F)}}return F}return{getParamIds:p,getParamValues:x,compilePattern:z}}());a.crossroads=e}(window||this));