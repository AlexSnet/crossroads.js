/*!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.4.0+
 * @build 41 (08/16/2011 10:24 PM)
 */
(function(b){var f,n,d=Object.prototype.toString,l=/^(true|false)$/i;function k(o,p){var q=o.length;while(q--){if(o[q]===p){return q}}return -1}function e(o,p){return"[object "+o+"]"===d.call(p)}function g(o){return e("RegExp",o)}function i(o){return e("Array",o)}function c(o){return e("Function",o)}function h(o){return(o===null)?o:(l.test(o)?(o.toLowerCase()==="true"):((o===""||isNaN(o))?o:parseFloat(o)))}function m(p){var q=p.length,o=[];while(q--){o[q]=h(p[q])}return o}function a(){this._routes=[];this.bypassed=new signals.Signal();this.routed=new signals.Signal()}a.prototype={create:function(){return new a()},shouldTypecast:true,addRoute:function(q,r,p){var o=new j(q,r,p,this);this._sortedInsert(o);return o},removeRoute:function(o){var p=k(this._routes,o);if(p>=0){this._routes.splice(p,1)}o._destroy()},removeAllRoutes:function(){var o=this.getNumRoutes();while(o--){this._routes[o]._destroy()}this._routes.length=0},parse:function(p){p=p||"";var o=this._getMatchedRoute(p),q=o?n.getParamValues(p,o._matchRegexp,this.shouldTypecast):null;if(o){q?o.matched.dispatch.apply(o.matched,q):o.matched.dispatch();this.routed.dispatch(p,o,q)}else{this.bypassed.dispatch(p)}},getNumRoutes:function(){return this._routes.length},_sortedInsert:function(p){var o=this._routes,q=o.length;do{--q}while(o[q]&&p._priority<=o[q]._priority);o.splice(q+1,0,p)},_getMatchedRoute:function(q){var o=this._routes,r=o.length,p;while(p=o[--r]){if(p.match(q)){return p}}return null},toString:function(){return"[crossroads numRoutes:"+this.getNumRoutes()+"]"}};f=new a();function j(q,s,p,o){var r=g(q);this._router=o;this._pattern=q;this._paramsIds=r?null:n.getParamIds(this._pattern);this._matchRegexp=r?q:n.compilePattern(q);this.matched=new signals.Signal();if(s){this.matched.add(s)}this._priority=p||0}j.prototype={rules:void (0),match:function(o){return this._matchRegexp.test(o)&&this._validateParams(o)},_validateParams:function(o){var p=this.rules,q;for(q in p){if(p.hasOwnProperty(q)&&!this._isValidParam(o,q)){return false}}return true},_isValidParam:function(q,t){var p=this.rules[t],o=this._getParamValuesObject(q),s=o[t],r;if(g(p)){r=p.test(s)}else{if(i(p)){r=k(p,s||"")!==-1}else{if(c(p)){r=p(s,q,o)}}}return r||false},_getParamValuesObject:function(r){var t=this._router.shouldTypecast,q=this._paramsIds,p=n.getParamValues(r,this._matchRegexp,t),s={},u=q?q.length:0;while(u--){s[q[u]]=p[u]}s.request_=t?h(r):r;return s},dispose:function(){this._router.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};n=f.patternLexer=(function(){var x=/[\\.+*?\^$\[\](){}\/'#]/g,z=/\/$/g,D=/([:}]|\w(?=\/))\/?(:)/g,o=/\{([^}]+)\}/g,t=/:([^:]+):/g,v=/(?:\{|:)([^}:]+)(?:\}|:)/g,u="___CR_REQ___",B="___CR_OPT___",r="___CR_OPT_SLASH___",E=new RegExp(u,"g"),p=new RegExp(B,"g"),C=new RegExp(r,"g");function q(H){var G=[],F;while(F=v.exec(H)){G.push(F[1])}return G}function A(F){F=F||"";if(F){F=F.replace(z,"");F=w(F);F=F.replace(x,"\\$&");F=s(F)}return new RegExp("^"+F+"/?$")}function w(F){F=F.replace(D,"$1"+r+"$2");F=F.replace(t,B);return F.replace(o,u)}function s(F){F=F.replace(C,"\\/?");F=F.replace(p,"([^\\/]+)?/?");return F.replace(E,"([^\\/]+)")}function y(F,H,I){var G=H.exec(F);if(G){G.shift();if(I){G=m(G)}}return G}return{getParamIds:q,getParamValues:y,compilePattern:A}}());b.crossroads=f}(window||this));