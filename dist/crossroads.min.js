/*!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.4.0+
 * @build 32 (06/18/2011 01:39 AM)
 */
(function(a){var e,i,l,c=Object.prototype.toString,k=/^(true|false)$/i;function j(m,o){var p=m.length;while(p--){if(m[p]===o){return p}}return -1}function d(m,n){return"[object "+m+"]"===c.call(n)}function f(m){return d("RegExp",m)}function h(m){return d("Array",m)}function b(m){return d("Function",m)}function g(m){return(m===null)?m:(k.test(m)?(m.toLowerCase()==="true"):((m===""||isNaN(m))?m:parseFloat(m)))}e=(function(){var p={shouldTypecast:true,_routes:[],bypassed:new signals.Signal(),routed:new signals.Signal(),addRoute:function(t,u,s){var r=new i(t,u,s);m(r);return r},removeRoute:function(r){var s=o(r);if(s>=0){this._routes.splice(s,1)}r._destroy()},removeAllRoutes:function(){var r=this.getNumRoutes();while(r--){this._routes[r]._destroy()}this._routes.length=0},parse:function(s){s=s||"";var r=n(s),t=r?q(s,r):null;if(r){t?r.matched.dispatch.apply(r.matched,t):r.matched.dispatch();this.routed.dispatch(s,r,t)}else{this.bypassed.dispatch(s)}},getNumRoutes:function(){return this._routes.length},toString:function(){return"[crossroads numRoutes:"+this.getNumRoutes()+"]"}};function m(s){var r=e._routes,t=r.length;do{--t}while(r[t]&&s._priority<=r[t]._priority);r.splice(t+1,0,s)}function o(r){return j(e._routes,r)}function n(t){var r=e._routes,u=r.length,s;while(s=r[--u]){if(s.match(t)){return s}}return null}function q(s,r){return l.getParamValues(s,r._matchRegexp)}return p}());i=function(n,p,m){var o=f(n);this._pattern=n;this._paramsIds=o?null:l.getParamIds(this._pattern);this._matchRegexp=o?n:l.compilePattern(n);this.matched=new signals.Signal();if(p){this.matched.add(p)}this._priority=m||0};i.prototype={rules:void (0),match:function(m){return this._matchRegexp.test(m)&&this._validateParams(m)},_validateParams:function(m){var n=this.rules,o;for(o in n){if(n.hasOwnProperty(o)&&!this._isValidParam(m,o)){return false}}return true},_isValidParam:function(o,r){var n=this.rules[r],m=this._getParamValuesObject(o),q=m[r],p;if(f(n)){p=n.test(q)}else{if(h(n)){p=j(n,q)!==-1}else{if(b(n)){p=n(q,o,m)}}}return p||false},_getParamValuesObject:function(q){var p=this._paramsIds,m=l.getParamValues(q,this._matchRegexp),r={},s=p?p.length:0;while(s--){r[p[s]]=m[s]}r.request_=e.shouldTypecast?g(q):q;return r},dispose:function(){e.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};l=e.patternLexer=(function(){var u=/[\\\.\+\*\?\^\$\[\]\(\)\{\}\/\'\#]/g,o=/([^\/]+)/,t=/\{([^\}]+)\}/g,s="___CR_PARAM___",r=new RegExp(s,"g");function p(A){var z=[],y;while(y=t.exec(A)){z.push(y[1])}return z}function w(y){y=y?q(y):"";y=y.replace(/\/$/,"");y=m(y);y=n(y);return new RegExp("^"+y+"/?$")}function q(y){return y.replace(t,s)}function n(y){return y.replace(r,o.source)}function m(y){return y.replace(u,"\\$&")}function v(y,A){var z=A.exec(y);if(z){z.shift();if(e.shouldTypecast){z=x(z)}}return z}function x(z){var A=z.length,y=[];while(A--){y[A]=g(z[A])}return y}return{getParamIds:p,getParamValues:v,compilePattern:w}}());a.crossroads=e}(window||this));