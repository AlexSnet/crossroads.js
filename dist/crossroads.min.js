/*!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.4.0+
 * @build 43 (08/17/2011 12:45 AM)
 */
(function(b){var e,m,l=/^(true|false)$/i;function k(o,p){var q=o.length;while(q--){if(o[q]===p){return q}}return -1}function d(n,o){return"[object "+n+"]"===Object.prototype.toString.call(o)}function f(n){return d("RegExp",n)}function h(n){return d("Array",n)}function c(n){return d("Function",n)}function g(n){return(n===null)?n:(l.test(n)?(n.toLowerCase()==="true"):((n===""||isNaN(n))?n:parseFloat(n)))}function j(p){var q=p.length,o=[];while(q--){o[q]=g(p[q])}return o}function a(){this._routes=[];this.bypassed=new signals.Signal();this.routed=new signals.Signal()}a.prototype={create:function(){return new a()},shouldTypecast:true,addRoute:function(p,q,o){var n=new i(p,q,o,this);this._sortedInsert(n);return n},removeRoute:function(n){var o=k(this._routes,n);if(o>=0){this._routes.splice(o,1)}n._destroy()},removeAllRoutes:function(){var o=this.getNumRoutes();while(o--){this._routes[o]._destroy()}this._routes.length=0},parse:function(o){o=o||"";var n=this._getMatchedRoute(o),p=n?m.getParamValues(o,n._matchRegexp,this.shouldTypecast):null;if(n){p?n.matched.dispatch.apply(n.matched,p):n.matched.dispatch();this.routed.dispatch(o,n,p)}else{this.bypassed.dispatch(o)}},getNumRoutes:function(){return this._routes.length},_sortedInsert:function(p){var o=this._routes,q=o.length;do{--q}while(o[q]&&p._priority<=o[q]._priority);o.splice(q+1,0,p)},_getMatchedRoute:function(q){var o=this._routes,r=o.length,p;while(p=o[--r]){if(p.match(q)){return p}}return null},toString:function(){return"[crossroads numRoutes:"+this.getNumRoutes()+"]"}};e=new a();function i(p,r,o,n){var q=f(p);this._router=n;this._pattern=p;this._paramsIds=q?null:m.getParamIds(this._pattern);this._matchRegexp=q?p:m.compilePattern(p);this.matched=new signals.Signal();if(r){this.matched.add(r)}this._priority=o||0}i.prototype={rules:void (0),match:function(n){return this._matchRegexp.test(n)&&this._validateParams(n)},_validateParams:function(o){var p=this.rules,n=this._getParamValuesObject(o),q;for(q in p){if(p.hasOwnProperty(q)&&!this._isValidParam(o,q,n)){return false}}return true},_isValidParam:function(p,s,n){var o=this.rules[s],r=n[s],q;if(f(o)){q=o.test(r)}else{if(h(o)){q=k(o,r||"")!==-1}else{if(c(o)){q=o(r,p,n)}}}return q||false},_getParamValuesObject:function(q){var s=this._router.shouldTypecast,p=m.getParamValues(q,this._matchRegexp,s),r={},t=p.length;while(t--){r[t]=p[t];if(this._paramsIds){r[this._paramsIds[t]]=p[t]}}r.request_=s?g(q):q;return r},dispose:function(){this._router.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};m=e.patternLexer=(function(){var w=/[\\.+*?\^$\[\](){}\/'#]/g,y=/\/$/g,C=/([:}]|\w(?=\/))\/?(:)/g,n=/\{([^}]+)\}/g,s=/:([^:]+):/g,u=/(?:\{|:)([^}:]+)(?:\}|:)/g,t="___CR_REQ___",A="___CR_OPT___",q="___CR_OPT_SLASH___",D=new RegExp(t,"g"),o=new RegExp(A,"g"),B=new RegExp(q,"g");function p(G){var F=[],E;while(E=u.exec(G)){F.push(E[1])}return F}function z(E){E=E||"";if(E){E=E.replace(y,"");E=v(E);E=E.replace(w,"\\$&");E=r(E)}return new RegExp("^"+E+"/?$")}function v(E){E=E.replace(C,"$1"+q+"$2");E=E.replace(s,A);return E.replace(n,t)}function r(E){E=E.replace(B,"\\/?");E=E.replace(o,"([^\\/]+)?/?");return E.replace(D,"([^\\/]+)")}function x(E,G,H){var F=G.exec(E);if(F){F.shift();if(H){F=j(F)}}return F}return{getParamIds:p,getParamValues:x,compilePattern:z}}());b.crossroads=e}(window||this));