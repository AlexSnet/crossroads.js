/*!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.3
 * @build 18 (05/03/2011 04:01 AM)
 */
(function(a){var e,h,j,c=Object.prototype.toString;function i(k,l){var m=k.length;while(m--){if(k[m]===l){return m}}return -1}function d(k,l){return"[object "+k+"]"===c.call(l)}function f(k){return d("RegExp",k)}function g(k){return d("Array",k)}function b(k){return d("Function",k)}e=(function(){var n=[],r=new signals.Signal(),u=new signals.Signal();function k(y,z,x){var w=new h(y,z,x);v(w);return w}function v(w){var x=l();do{--x}while(n[x]&&w._priority<=n[x]._priority);n.splice(x+1,0,w)}function l(){return n.length}function o(w){var x=q(w);if(x>=0){n.splice(x,1)}w._destroy()}function q(w){return i(n,w)}function t(){var w=l();while(w--){n[w]._destroy()}n.length=0}function m(x){x=x||"";var w=p(x),y=w?s(x,w):null;if(w){y?w.matched.dispatch.apply(w.matched,y):w.matched.dispatch();u.dispatch(x,w,y)}else{r.dispatch(x)}}function p(y){var x=l(),w;while(w=n[--x]){if(w.match(y)){return w}}return null}function s(x,w){return j.getParamValues(x,w._matchRegexp)}return{_routes:n,addRoute:k,removeRoute:o,removeAllRoutes:t,parse:m,bypassed:r,routed:u,getNumRoutes:l,toString:function(){return"[crossroads numRoutes:"+l()+"]"}}}());h=function(l,m,k){this._pattern=l;this._matchRegexp=f(l)?l:j.compilePattern(l);this.matched=new signals.Signal();if(m){this.matched.add(m)}this._priority=k||0};h.prototype={rules:void (0),match:function(k){return this._matchRegexp.test(k)&&(f(this._pattern)||this._validateParams(k))},_validateParams:function(k){var l=this.rules,m;for(m in l){if(l.hasOwnProperty(m)){if(!this._isValidParam(k,m)){return false}}}return true},_isValidParam:function(m,p){var l=this.rules[p],k=this._getParamValuesObject(m),o=k[p],n;if(f(l)){n=l.test(o)}else{if(g(l)){n=i(l,o)!==-1}else{if(b(l)){n=l(o,m,k)}}}return n||false},_getParamValuesObject:function(m){var l=j.getParamIds(this._pattern),k=j.getParamValues(m,this._matchRegexp),p={},q=l.length;while(q--){p[l[q]]=k[q]}return p},dispose:function(){e.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};j=e.patternLexer=(function(){var s=/[\\\.\+\*\?\^\$\[\]\(\)\{\}\/\'\#]/g,m=/([^\/]+)/,r=/\{([^\}]+)\}/g,q="___CR_PARAM___",p=new RegExp(q,"g");function n(y){var x=[],w;while(w=r.exec(y)){x.push(w[1])}return x}function u(w){w=w?o(w):"";w=k(w);w=l(w);return new RegExp("^"+w+"$")}function o(w){return w.replace(r,q)}function l(w){return w.replace(p,m.source)}function k(w){return w.replace(s,"\\$&")}function t(w,y){var x=y.exec(w);if(x){x.shift();x=v(x)}return x}function v(x){var z=x.length,w=[],y;while(y=x[--z]){w[z]=(y===null||y===""||isNaN(y))?y:parseFloat(y)}return w}return{getParamIds:n,getParamValues:t,compilePattern:u}}());a.crossroads=e}(window||this));